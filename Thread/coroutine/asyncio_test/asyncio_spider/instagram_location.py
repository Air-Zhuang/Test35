import asyncio
import ssl

import aiohttp
import aiomysql
import re
import requests
import time

stopping=False

base_url="https://www.instagram.com/explore/locations/"
headers = {
        "X-Instagram-AJAX": "",
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "",
        "Host": "www.instagram.com",
        "Content-Length": "6",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36"
    }
waitting_city_queue=asyncio.Queue()
# country_urls=['https://www.instagram.com/explore/locations/US/?__a=1', 'https://www.instagram.com/explore/locations/BR/?__a=1', 'https://www.instagram.com/explore/locations/IN/?__a=1', 'https://www.instagram.com/explore/locations/DE/?__a=1', 'https://www.instagram.com/explore/locations/GB/?__a=1', 'https://www.instagram.com/explore/locations/FR/?__a=1', 'https://www.instagram.com/explore/locations/MX/?__a=1', 'https://www.instagram.com/explore/locations/TH/?__a=1', 'https://www.instagram.com/explore/locations/ID/?__a=1', 'https://www.instagram.com/explore/locations/JP/?__a=1', 'https://www.instagram.com/explore/locations/ES/?__a=1', 'https://www.instagram.com/explore/locations/CA/?__a=1', 'https://www.instagram.com/explore/locations/AU/?__a=1', 'https://www.instagram.com/explore/locations/TR/?__a=1', 'https://www.instagram.com/explore/locations/VN/?__a=1', 'https://www.instagram.com/explore/locations/KR/?__a=1', 'https://www.instagram.com/explore/locations/IT/?__a=1', 'https://www.instagram.com/explore/locations/PH/?__a=1', 'https://www.instagram.com/explore/locations/TW/?__a=1', 'https://www.instagram.com/explore/locations/MY/?__a=1', 'https://www.instagram.com/explore/locations/ZA/?__a=1', 'https://www.instagram.com/explore/locations/RU/?__a=1', 'https://www.instagram.com/explore/locations/AR/?__a=1', 'https://www.instagram.com/explore/locations/SE/?__a=1', 'https://www.instagram.com/explore/locations/NL/?__a=1', 'https://www.instagram.com/explore/locations/CL/?__a=1', 'https://www.instagram.com/explore/locations/CO/?__a=1', 'https://www.instagram.com/explore/locations/PE/?__a=1', 'https://www.instagram.com/explore/locations/PL/?__a=1', 'https://www.instagram.com/explore/locations/BE/?__a=1', 'https://www.instagram.com/explore/locations/GR/?__a=1', 'https://www.instagram.com/explore/locations/RO/?__a=1', 'https://www.instagram.com/explore/locations/IL/?__a=1', 'https://www.instagram.com/explore/locations/CH/?__a=1', 'https://www.instagram.com/explore/locations/SG/?__a=1', 'https://www.instagram.com/explore/locations/DK/?__a=1', 'https://www.instagram.com/explore/locations/PK/?__a=1', 'https://www.instagram.com/explore/locations/NO/?__a=1', 'https://www.instagram.com/explore/locations/UA/?__a=1', 'https://www.instagram.com/explore/locations/PT/?__a=1', 'https://www.instagram.com/explore/locations/HK/?__a=1', 'https://www.instagram.com/explore/locations/CN/?__a=1', 'https://www.instagram.com/explore/locations/EG/?__a=1', 'https://www.instagram.com/explore/locations/AT/?__a=1', 'https://www.instagram.com/explore/locations/CZ/?__a=1', 'https://www.instagram.com/explore/locations/IE/?__a=1', 'https://www.instagram.com/explore/locations/EC/?__a=1', 'https://www.instagram.com/explore/locations/AE/?__a=1', 'https://www.instagram.com/explore/locations/HU/?__a=1', 'https://www.instagram.com/explore/locations/BD/?__a=1', 'https://www.instagram.com/explore/locations/FI/?__a=1', 'https://www.instagram.com/explore/locations/NG/?__a=1', 'https://www.instagram.com/explore/locations/NZ/?__a=1', 'https://www.instagram.com/explore/locations/PR/?__a=1', 'https://www.instagram.com/explore/locations/IR/?__a=1', 'https://www.instagram.com/explore/locations/SA/?__a=1', 'https://www.instagram.com/explore/locations/CR/?__a=1', 'https://www.instagram.com/explore/locations/BG/?__a=1', 'https://www.instagram.com/explore/locations/MA/?__a=1', 'https://www.instagram.com/explore/locations/VE/?__a=1', 'https://www.instagram.com/explore/locations/RS/?__a=1', 'https://www.instagram.com/explore/locations/HR/?__a=1', 'https://www.instagram.com/explore/locations/KH/?__a=1', 'https://www.instagram.com/explore/locations/PY/?__a=1', 'https://www.instagram.com/explore/locations/GT/?__a=1', 'https://www.instagram.com/explore/locations/DO/?__a=1', 'https://www.instagram.com/explore/locations/IQ/?__a=1', 'https://www.instagram.com/explore/locations/MM/?__a=1', 'https://www.instagram.com/explore/locations/BO/?__a=1', 'https://www.instagram.com/explore/locations/LK/?__a=1', 'https://www.instagram.com/explore/locations/SK/?__a=1', 'https://www.instagram.com/explore/locations/LB/?__a=1', 'https://www.instagram.com/explore/locations/DZ/?__a=1', 'https://www.instagram.com/explore/locations/TN/?__a=1', 'https://www.instagram.com/explore/locations/LV/?__a=1', 'https://www.instagram.com/explore/locations/KE/?__a=1', 'https://www.instagram.com/explore/locations/NP/?__a=1', 'https://www.instagram.com/explore/locations/CY/?__a=1', 'https://www.instagram.com/explore/locations/AZ/?__a=1', 'https://www.instagram.com/explore/locations/SV/?__a=1', 'https://www.instagram.com/explore/locations/LA/?__a=1', 'https://www.instagram.com/explore/locations/UY/?__a=1', 'https://www.instagram.com/explore/locations/HN/?__a=1', 'https://www.instagram.com/explore/locations/LT/?__a=1', 'https://www.instagram.com/explore/locations/BA/?__a=1', 'https://www.instagram.com/explore/locations/KW/?__a=1', 'https://www.instagram.com/explore/locations/KZ/?__a=1', 'https://www.instagram.com/explore/locations/MK/?__a=1', 'https://www.instagram.com/explore/locations/PA/?__a=1', 'https://www.instagram.com/explore/locations/GE/?__a=1', 'https://www.instagram.com/explore/locations/JO/?__a=1', 'https://www.instagram.com/explore/locations/BY/?__a=1', 'https://www.instagram.com/explore/locations/EE/?__a=1', 'https://www.instagram.com/explore/locations/GH/?__a=1', 'https://www.instagram.com/explore/locations/SI/?__a=1', 'https://www.instagram.com/explore/locations/NI/?__a=1', 'https://www.instagram.com/explore/locations/AL/?__a=1', 'https://www.instagram.com/explore/locations/QA/?__a=1', 'https://www.instagram.com/explore/locations/SY/?__a=1', 'https://www.instagram.com/explore/locations/TZ/?__a=1', 'https://www.instagram.com/explore/locations/TT/?__a=1', 'https://www.instagram.com/explore/locations/AO/?__a=1', 'https://www.instagram.com/explore/locations/AF/?__a=1', 'https://www.instagram.com/explore/locations/CD/?__a=1', 'https://www.instagram.com/explore/locations/BN/?__a=1', 'https://www.instagram.com/explore/locations/CI/?__a=1', 'https://www.instagram.com/explore/locations/JM/?__a=1', 'https://www.instagram.com/explore/locations/UG/?__a=1', 'https://www.instagram.com/explore/locations/ZM/?__a=1', 'https://www.instagram.com/explore/locations/AM/?__a=1', 'https://www.instagram.com/explore/locations/MD/?__a=1', 'https://www.instagram.com/explore/locations/PS/?__a=1', 'https://www.instagram.com/explore/locations/MN/?__a=1', 'https://www.instagram.com/explore/locations/LU/?__a=1', 'https://www.instagram.com/explore/locations/MZ/?__a=1', 'https://www.instagram.com/explore/locations/LY/?__a=1', 'https://www.instagram.com/explore/locations/BH/?__a=1', 'https://www.instagram.com/explore/locations/MO/?__a=1', 'https://www.instagram.com/explore/locations/KP/?__a=1', 'https://www.instagram.com/explore/locations/IS/?__a=1', 'https://www.instagram.com/explore/locations/CM/?__a=1', 'https://www.instagram.com/explore/locations/MT/?__a=1', 'https://www.instagram.com/explore/locations/UZ/?__a=1', 'https://www.instagram.com/explore/locations/OM/?__a=1', 'https://www.instagram.com/explore/locations/MV/?__a=1', 'https://www.instagram.com/explore/locations/ME/?__a=1', 'https://www.instagram.com/explore/locations/SN/?__a=1', 'https://www.instagram.com/explore/locations/BW/?__a=1', 'https://www.instagram.com/explore/locations/RE/?__a=1', 'https://www.instagram.com/explore/locations/SD/?__a=1', 'https://www.instagram.com/explore/locations/NA/?__a=1', 'https://www.instagram.com/explore/locations/ZW/?__a=1', 'https://www.instagram.com/explore/locations/MG/?__a=1', 'https://www.instagram.com/explore/locations/CU/?__a=1', 'https://www.instagram.com/explore/locations/BS/?__a=1', 'https://www.instagram.com/explore/locations/HT/?__a=1', 'https://www.instagram.com/explore/locations/ET/?__a=1', 'https://www.instagram.com/explore/locations/PG/?__a=1', 'https://www.instagram.com/explore/locations/VA/?__a=1', 'https://www.instagram.com/explore/locations/KG/?__a=1', 'https://www.instagram.com/explore/locations/FJ/?__a=1', 'https://www.instagram.com/explore/locations/XK/?__a=1', 'https://www.instagram.com/explore/locations/SR/?__a=1', 'https://www.instagram.com/explore/locations/YE/?__a=1', 'https://www.instagram.com/explore/locations/GP/?__a=1', 'https://www.instagram.com/explore/locations/MU/?__a=1', 'https://www.instagram.com/explore/locations/MW/?__a=1', 'https://www.instagram.com/explore/locations/BF/?__a=1', 'https://www.instagram.com/explore/locations/BB/?__a=1', 'https://www.instagram.com/explore/locations/ML/?__a=1', 'https://www.instagram.com/explore/locations/MQ/?__a=1', 'https://www.instagram.com/explore/locations/MP/?__a=1', 'https://www.instagram.com/explore/locations/GY/?__a=1', 'https://www.instagram.com/explore/locations/BJ/?__a=1', 'https://www.instagram.com/explore/locations/BZ/?__a=1', 'https://www.instagram.com/explore/locations/SO/?__a=1', 'https://www.instagram.com/explore/locations/GA/?__a=1', 'https://www.instagram.com/explore/locations/CG/?__a=1', 'https://www.instagram.com/explore/locations/AW/?__a=1', 'https://www.instagram.com/explore/locations/NC/?__a=1', 'https://www.instagram.com/explore/locations/IM/?__a=1', 'https://www.instagram.com/explore/locations/JE/?__a=1', 'https://www.instagram.com/explore/locations/CF/?__a=1', 'https://www.instagram.com/explore/locations/CW/?__a=1', 'https://www.instagram.com/explore/locations/LR/?__a=1', 'https://www.instagram.com/explore/locations/GN/?__a=1', 'https://www.instagram.com/explore/locations/TD/?__a=1', 'https://www.instagram.com/explore/locations/NE/?__a=1', 'https://www.instagram.com/explore/locations/PF/?__a=1', 'https://www.instagram.com/explore/locations/LS/?__a=1', 'https://www.instagram.com/explore/locations/TG/?__a=1', 'https://www.instagram.com/explore/locations/KY/?__a=1', 'https://www.instagram.com/explore/locations/SS/?__a=1', 'https://www.instagram.com/explore/locations/SL/?__a=1', 'https://www.instagram.com/explore/locations/AD/?__a=1', 'https://www.instagram.com/explore/locations/RW/?__a=1', 'https://www.instagram.com/explore/locations/CV/?__a=1', 'https://www.instagram.com/explore/locations/LC/?__a=1', 'https://www.instagram.com/explore/locations/TJ/?__a=1', 'https://www.instagram.com/explore/locations/BT/?__a=1', 'https://www.instagram.com/explore/locations/AG/?__a=1', 'https://www.instagram.com/explore/locations/BM/?__a=1', 'https://www.instagram.com/explore/locations/FO/?__a=1', 'https://www.instagram.com/explore/locations/GG/?__a=1', 'https://www.instagram.com/explore/locations/GF/?__a=1', 'https://www.instagram.com/explore/locations/GU/?__a=1', 'https://www.instagram.com/explore/locations/MC/?__a=1', 'https://www.instagram.com/explore/locations/GL/?__a=1', 'https://www.instagram.com/explore/locations/GM/?__a=1', 'https://www.instagram.com/explore/locations/AQ/?__a=1', 'https://www.instagram.com/explore/locations/BI/?__a=1', 'https://www.instagram.com/explore/locations/GD/?__a=1', 'https://www.instagram.com/explore/locations/VI/?__a=1', 'https://www.instagram.com/explore/locations/TM/?__a=1', 'https://www.instagram.com/explore/locations/SZ/?__a=1', 'https://www.instagram.com/explore/locations/MR/?__a=1', 'https://www.instagram.com/explore/locations/SC/?__a=1', 'https://www.instagram.com/explore/locations/VC/?__a=1', 'https://www.instagram.com/explore/locations/GI/?__a=1', 'https://www.instagram.com/explore/locations/SB/?__a=1', 'https://www.instagram.com/explore/locations/GW/?__a=1', 'https://www.instagram.com/explore/locations/GQ/?__a=1', 'https://www.instagram.com/explore/locations/TC/?__a=1', 'https://www.instagram.com/explore/locations/VU/?__a=1', 'https://www.instagram.com/explore/locations/KN/?__a=1', 'https://www.instagram.com/explore/locations/SX/?__a=1', 'https://www.instagram.com/explore/locations/LI/?__a=1', 'https://www.instagram.com/explore/locations/DM/?__a=1', 'https://www.instagram.com/explore/locations/BQ/?__a=1', 'https://www.instagram.com/explore/locations/WS/?__a=1', 'https://www.instagram.com/explore/locations/EH/?__a=1', 'https://www.instagram.com/explore/locations/SM/?__a=1', 'https://www.instagram.com/explore/locations/DJ/?__a=1', 'https://www.instagram.com/explore/locations/VG/?__a=1', 'https://www.instagram.com/explore/locations/ER/?__a=1', 'https://www.instagram.com/explore/locations/YT/?__a=1', 'https://www.instagram.com/explore/locations/TL/?__a=1', 'https://www.instagram.com/explore/locations/TO/?__a=1', 'https://www.instagram.com/explore/locations/AS/?__a=1', 'https://www.instagram.com/explore/locations/KM/?__a=1', 'https://www.instagram.com/explore/locations/MF/?__a=1', 'https://www.instagram.com/explore/locations/CK/?__a=1', 'https://www.instagram.com/explore/locations/ST/?__a=1', 'https://www.instagram.com/explore/locations/AI/?__a=1', 'https://www.instagram.com/explore/locations/PW/?__a=1', 'https://www.instagram.com/explore/locations/FK/?__a=1', 'https://www.instagram.com/explore/locations/FM/?__a=1', 'https://www.instagram.com/explore/locations/SJ/?__a=1', 'https://www.instagram.com/explore/locations/KI/?__a=1', 'https://www.instagram.com/explore/locations/AN/?__a=1', 'https://www.instagram.com/explore/locations/NR/?__a=1', 'https://www.instagram.com/explore/locations/MH/?__a=1', 'https://www.instagram.com/explore/locations/SH/?__a=1', 'https://www.instagram.com/explore/locations/MS/?__a=1', 'https://www.instagram.com/explore/locations/WF/?__a=1', 'https://www.instagram.com/explore/locations/PM/?__a=1', 'https://www.instagram.com/explore/locations/TV/?__a=1', 'https://www.instagram.com/explore/locations/NU/?__a=1', 'https://www.instagram.com/explore/locations/GS/?__a=1', 'https://www.instagram.com/explore/locations/CX/?__a=1', 'https://www.instagram.com/explore/locations/NF/?__a=1', 'https://www.instagram.com/explore/locations/PN/?__a=1', 'https://www.instagram.com/explore/locations/TF/?__a=1', 'https://www.instagram.com/explore/locations/CC/?__a=1', 'https://www.instagram.com/explore/locations/TK/?__a=1']
country_urls=['https://www.instagram.com/explore/locations/CN/?__a=1']
seen_urls=set()

async def fetch_http(url,page,session):
    try:
        async with session.post(url,data={'page':page},headers=headers,ssl=False) as resp:      #aiohttp不支持自动下载ssl证书，卡在这里了
            if resp.status in [200,201]:
                data = await resp.json()
                return data
    except Exception as e:
        print("!!!!Exception:",e)

async def gene_urls(delay_time=0.5):
    async with aiohttp.ClientSession() as session:
        while not stopping:
            for country_url in country_urls:
                next_page=1
                while next_page:
                    result=await fetch_http(country_url,next_page,session)
                    for i in result['city-list']:
                        waitting_city_queue.put_nowait(base_url+i["id"]+"/"+i["slug"]+"/")
                    next_page=result["next_page"]
                    await asyncio.sleep(delay_time)
                    print(waitting_city_queue)

'''启动函数'''
async def main(loop):
    pool=await aiomysql.create_pool(host='127.0.0.1',port=3306,user='root',password='123456',db='instagram',loop=loop,charset='utf8',autocommit=True)

    asyncio.ensure_future(gene_urls(delay_time=2))



if __name__ == '__main__':
    requests.packages.urllib3.disable_warnings()
    session = requests.session()

    headers = {
        "X-Instagram-AJAX": "",
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "",
        "Host": "www.instagram.com",
        "Content-Length": "6",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36"
    }
    res = requests.get(url="https://www.instagram.com/explore/locations/", verify=False)
    source = res.text
    time.sleep(3)

    ma_csrf = re.search(r'{"csrf_token":"(.*?)",', source)
    csrf_token = ma_csrf.group(1)
    print(csrf_token)  # 获取csrf_token
    headers["X-CSRFToken"] = csrf_token
    ma_ajax_code = re.search(r'"rollout_hash":"(.*?)",', source)
    ajax_code = ma_ajax_code.group(1)
    print(ajax_code)  # 获取ajax_code
    headers["X-Instagram-AJAX"] = ajax_code

    loop = asyncio.get_event_loop()
    asyncio.ensure_future(main(loop))
    loop.run_forever()